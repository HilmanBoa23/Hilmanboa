<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=0.75">
    <title>Aplikasi Pembukuan Usaha (V6 - Revisi Riwayat)</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f4f9; color: #333; margin: 0; padding: 0; }
        .total-container { background-color: #2c3e50; color: white; padding: 15px 25px; text-align: center; position: sticky; top: 0; z-index: 1000; display: flex; justify-content: space-around; align-items: center; flex-wrap: wrap; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .total-container h2 { margin: 0; font-size: 1.2em; }
        .total-container p { margin: 5px 0 0 0; font-size: 1.3em; font-weight: bold; }
        .total-box { border: 1px solid #34495e; padding: 10px 20px; border-radius: 8px; background-color: #34495e; flex-grow: 1; }
        .total-box.utama { background-color: #27ae60; border-color: #2ecc71; width: 100%; order: -1; }
        .tab-container { display: flex; background-color: #34495e; justify-content: center; }
        .tab-button { background-color: #34495e; color: white; border: none; padding: 14px 20px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        .tab-button:hover, .tab-button.active { background-color: #4a627a; }
        .tab-content { display: none; padding: 25px; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .btn { color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 1em; margin-right: 5px; }
        .btn-danger { background-color: #e74c3c; } .btn-success { background-color: #2ecc71; } .btn-info { background-color: #3498db; } .btn-secondary { background-color: #95a5a6; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #ecf0f1; }
        .riwayat-group-header { font-size: 1.3em; font-weight: bold; padding: 15px 0 5px 0; color: #2c3e50; margin-top: 10px; }
        .subtotal-row td { font-weight: bold; background-color: #f0f8ff; }
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .close-button { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close-button:hover { color: #000; }
        #struk-content { font-family: 'Courier New', Courier, monospace; }
        #struk-content .toko-info { text-align: center; margin-bottom: 15px; }
        #struk-content h4 { margin: 0; font-size: 1.2em; }
        #struk-content p { margin: 2px 0; }
        #struk-content table { width: 100%; font-size: 0.9em; margin-top: 10px; }
        #struk-content th, #struk-content td { border: none; padding: 2px; }
        #struk-content .text-right { text-align: right; }
        #struk-content .ucapan { text-align: center; margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 10px; }
        .modal-footer { text-align: right; margin-top: 20px; }
        @media print { body * { visibility: hidden; } #struk-content, #struk-content * { visibility: visible; } #struk-content { position: absolute; left: 0; top: 0; width: 100%; } }
    </style>
</head>
<body>

<div class="total-container">
    <div class="total-box utama"><h2>𝐃𝐚𝐩𝐮𝐫 𝐃𝐨𝐚 𝐔𝐦𝐢 x 𝐑𝐢𝐬𝐨𝐥𝐞𝐬 𝐇𝐲𝐫𝐚</h2><p id="total-bersih">Rp 0</p></div>
    <div class="total-box"><h2>📈 Uang Masuk</h2><p id="total-masuk">Rp 0</p></div>
    <div class="total-box"><h2>📉 Uang Keluar</h2><p id="total-keluar">Rp 0</p></div>
</div>
<div class="tab-container">
    <button class="tab-button active" onclick="openTab(event, 'kasir')">Kasir</button>
    <button class="tab-button" onclick="openTab(event, 'admin')">Admin</button>
    <button class="tab-button" onclick="openTab(event, 'pemasukan')">Pemasukan</button>
    <button class="tab-button" onclick="openTab(event, 'pengeluaran')">Pengeluaran</button>
    <button class="tab-button" onclick="openTab(event, 'riwayat')">Riwayat Transaksi</button>
</div>
<div id="kasir" class="tab-content active"><h3>Kasir</h3><div class="form-group"><label for="produk-kasir">Pilih Produk</label><select id="produk-kasir"></select></div><div class="form-group"><label for="nama-pelanggan">Nama Pelanggan / Catatan</label><input type="text" id="nama-pelanggan" placeholder="cth: Budi, Meja 5"></div><div class="form-group"><label for="jumlah-kasir">Jumlah</label><input type="number" id="jumlah-kasir" value="1" min="1"></div><div class="form-group"><label for="catatan-kasir">Catatan Produk</label><textarea id="catatan-kasir" rows="2" placeholder="cth: Pedas, tidak pakai sayur"></textarea></div><button class="btn btn-success" onclick="tambahKeKeranjang()">Tambah ke Keranjang</button><h3>Keranjang</h3><table id="tabel-keranjang"><thead><tr><th>Produk</th><th>Jumlah</th><th>Total</th><th>Aksi</th></tr></thead><tbody></tbody></table><br><button class="btn btn-info" onclick="prosesTransaksi()">Transaksikan</button></div>
<div id="admin" class="tab-content"><h3>Admin - Manajemen Produk</h3><div class="form-group"><label for="nama-produk">Nama Produk</label><input type="text" id="nama-produk" placeholder="Contoh: Risol Mayo"></div><div class="form-group"><label for="harga-produk">Harga</label><input type="number" id="harga-produk" placeholder="Contoh: 2500"></div><div class="form-group"><label for="stok-produk">Stok</label><input type="number" id="stok-produk" placeholder="Contoh: 100"></div><button class="btn" onclick="tambahProduk()">Tambah Produk Baru</button><hr><h3>Data Produk</h3><table id="tabel-produk"><thead><tr><th>Nama Produk</th><th>Harga</th><th>Stok</th></tr></thead><tbody></tbody></table><br><button class="btn btn-success" onclick="exportData('produk')">Export Data Produk (Excel)</button><div class="form-group" style="margin-top: 15px;"><label for="import-file">Import Data Produk dari Excel</label><input type="file" id="import-file" accept=".xlsx, .xls, .csv" onchange="importData(event)"><small>Pastikan file Excel memiliki kolom dengan header: <b>nama</b>, <b>harga</b>, <b>stok</b>.</small></div></div>
<div id="pemasukan" class="tab-content"><h3>Input Pemasukan (Modal & Lainnya)</h3><div class="form-group"><label for="ket-pemasukan">Keterangan</label><input type="text" id="ket-pemasukan" placeholder="Contoh: Modal awal, pinjaman"></div><div class="form-group"><label for="nominal-pemasukan">Nominal Uang Masuk</label><input type="number" id="nominal-pemasukan" placeholder="Masukkan jumlah uang"></div><button class="btn" onclick="catatPemasukan()">Input</button></div>
<div id="pengeluaran" class="tab-content"><h3>Input Pengeluaran</h3><div class="form-group"><label for="ket-pengeluaran">Keterangan</label><input type="text" id="ket-pengeluaran" placeholder="Contoh: Beli bahan baku, bayar listrik"></div><div class="form-group"><label for="nominal-pengeluaran">Nominal Uang Keluar</label><input type="number" id="nominal-pengeluaran" placeholder="Masukkan jumlah uang"></div><button class="btn" onclick="catatPengeluaran()">Input</button></div>
<div id="riwayat" class="tab-content"><h3>Riwayat Transaksi</h3><div id="riwayat-container"></div><br><button class="btn btn-success" onclick="exportData('riwayat')">Export Riwayat ke Excel</button></div>

<div id="struk-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3>Detail Struk</h3><span class="close-button" onclick="tutupStruk()">&times;</span></div><div id="struk-content"><div class="toko-info"><h4 id="struk-nama-toko">Nama Toko Anda</h4><p id="struk-alamat-toko">Alamat Toko Anda</p><p id="struk-kontak-toko">No. HP: 081234567890</p></div><hr><p>No: <span id="struk-no-transaksi"></span></p><p>Tgl: <span id="struk-tanggal"></span></p><p>Kasir: Admin</p><hr><table><tbody id="struk-item-list"></tbody></table><hr><div class="ucapan"><p>-- Terima Kasih --</p></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="printStruk()">🖨️ Print</button><button class="btn btn-danger" onclick="exportStrukPDF()">📄 Export PDF</button></div></div></div>

<script>
// --- KONFIGURASI TOKO (Silakan ubah sesuai data toko Anda) ---
const NAMA_TOKO = "𝐃𝐚𝐩𝐮𝐫 𝐃𝐨𝐚 𝐔𝐦𝐢 x 𝐑𝐢𝐬𝐨𝐥𝐞𝐬 𝐇𝐲𝐫𝐚";
const ALAMAT_TOKO = "Ds Binangun Rt 12 Rw 11";
const KONTAK_TOKO = "085161231424";
const { jsPDF } = window.jspdf;

let produk = [{ nama: 'Risol Mayo', harga: 2500, stok: 50 }, { nama: 'Ayam Goreng', harga: 15000, stok: 30 }];
let keranjang = [];
let riwayat = [];

// --- FUNGSI INTI (Disingkat untuk kejelasan) ---
document.addEventListener('DOMContentLoaded', () => { document.getElementById('kasir').style.display = 'block'; updateTabelProduk(); updateOpsiProduk(); updateTampilanTotal(); updateTabelRiwayat(); });
function openTab(evt, tabName) { let i, tabcontent, tablinks; tabcontent = document.getElementsByClassName("tab-content"); for (i = 0; i < tabcontent.length; i++) { tabcontent[i].style.display = "none"; } tablinks = document.getElementsByClassName("tab-button"); for (i = 0; i < tablinks.length; i++) { tablinks[i].className = tablinks[i].className.replace(" active", ""); } document.getElementById(tabName).style.display = "block"; evt.currentTarget.className += " active"; }
function formatRupiah(angka) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka); }
function updateTampilanTotal() { const { totalMasuk, totalKeluar } = riwayat.reduce((acc, curr) => { if (curr.total > 0) acc.totalMasuk += curr.total; else acc.totalKeluar += Math.abs(curr.total); return acc; }, { totalMasuk: 0, totalKeluar: 0 }); const totalBersih = totalMasuk - totalKeluar; document.getElementById('total-bersih').innerText = formatRupiah(totalBersih); document.getElementById('total-masuk').innerText = formatRupiah(totalMasuk); document.getElementById('total-keluar').innerText = formatRupiah(totalKeluar); }
function tambahProduk() { const nama = document.getElementById('nama-produk').value; const harga = parseFloat(document.getElementById('harga-produk').value); const stok = parseInt(document.getElementById('stok-produk').value); if (nama && harga > 0 && stok >= 0) { produk.push({ nama, harga, stok }); updateTabelProduk(); updateOpsiProduk(); document.getElementById('nama-produk').value = ''; document.getElementById('harga-produk').value = ''; document.getElementById('stok-produk').value = ''; alert('Produk berhasil ditambahkan!'); } else { alert('Harap isi semua data produk dengan benar.'); } }
function updateTabelProduk() { const tbody = document.querySelector('#tabel-produk tbody'); tbody.innerHTML = ''; produk.forEach(p => { const row = tbody.insertRow(); row.innerHTML = `<td>${p.nama}</td><td>${formatRupiah(p.harga)}</td><td>${p.stok}</td>`; }); }
function updateOpsiProduk() { const select = document.getElementById('produk-kasir'); select.innerHTML = ''; produk.forEach((p, index) => { if (p.stok > 0) { const option = document.createElement('option'); option.value = index; option.textContent = `${p.nama} (Stok: ${p.stok}) - ${formatRupiah(p.harga)}`; select.appendChild(option); } }); }
function tambahKeKeranjang() { const produkIndex = document.getElementById('produk-kasir').value; const jumlah = parseInt(document.getElementById('jumlah-kasir').value); if (produkIndex === '' || !jumlah || jumlah <= 0) { alert('Pilih produk dan masukkan jumlah yang valid.'); return; } const produkTerpilih = produk[produkIndex]; if (jumlah > produkTerpilih.stok) { alert(`Stok tidak mencukupi. Stok ${produkTerpilih.nama} tersisa ${produkTerpilih.stok}.`); return; } const itemDiKeranjang = { ...produkTerpilih, jumlah, total: produkTerpilih.harga * jumlah, produkIndex }; keranjang.push(itemDiKeranjang); updateTabelKeranjang(); }
function updateTabelKeranjang() { const tbody = document.querySelector('#tabel-keranjang tbody'); tbody.innerHTML = ''; keranjang.forEach((item, index) => { const row = tbody.insertRow(); row.innerHTML = `<td>${item.nama}</td><td>${item.jumlah}</td><td>${formatRupiah(item.total)}</td><td><button class="btn btn-danger btn-sm" onclick="hapusDariKeranjang(${index})">Hapus</button></td>`; }); }
function hapusDariKeranjang(index) { keranjang.splice(index, 1); updateTabelKeranjang(); }
function prosesTransaksi() { if (keranjang.length === 0) { alert('Keranjang masih kosong.'); return; } const waktu = new Date(); const totalTransaksi = keranjang.reduce((sum, item) => sum + item.total, 0); const transaksi = { id: waktu.getTime(), waktu: waktu, tipe: 'Penjualan', items: [...keranjang], total: totalTransaksi, catatan: document.getElementById('nama-pelanggan').value || '-' }; riwayat.push(transaksi); transaksi.items.forEach(item => { produk[item.produkIndex].stok -= item.jumlah; }); updateTampilanTotal(); updateTabelRiwayat(); updateOpsiProduk(); updateTabelProduk(); tampilkanStruk(transaksi); keranjang = []; updateTabelKeranjang(); document.getElementById('nama-pelanggan').value = ''; document.getElementById('catatan-kasir').value = ''; }
function catatPemasukan() { const keterangan = document.getElementById('ket-pemasukan').value; const nominal = parseFloat(document.getElementById('nominal-pemasukan').value); if (keterangan && nominal > 0) { riwayat.push({ id: Date.now(), waktu: new Date(), tipe: 'Pemasukan', items: [{nama: keterangan, total: nominal}], total: nominal, catatan: 'Internal' }); updateTampilanTotal(); updateTabelRiwayat(); document.getElementById('ket-pemasukan').value = ''; document.getElementById('nominal-pemasukan').value = ''; alert('Pemasukan berhasil dicatat.'); } else { alert('Keterangan dan nominal harus diisi dengan benar.'); } }
function catatPengeluaran() { const keterangan = document.getElementById('ket-pengeluaran').value; const nominal = parseFloat(document.getElementById('nominal-pengeluaran').value); if (keterangan && nominal > 0) { riwayat.push({ id: Date.now(), waktu: new Date(), tipe: 'Pengeluaran', items: [{nama: keterangan, total: -nominal}], total: -nominal, catatan: 'Internal' }); updateTampilanTotal(); updateTabelRiwayat(); document.getElementById('ket-pengeluaran').value = ''; document.getElementById('nominal-pengeluaran').value = ''; alert('Pengeluaran berhasil dicatat.'); } else { alert('Keterangan dan nominal harus diisi dengan benar.'); } }
function hapusRiwayat(id) { const index = riwayat.findIndex(r => r.id === id); if (index > -1) { const itemDihapus = riwayat[index]; if (itemDihapus.tipe === 'Penjualan') { itemDihapus.items.forEach(item => { const pIndex = produk.findIndex(p => p.nama === item.nama); if(pIndex > -1) produk[pIndex].stok += item.jumlah; }); } riwayat.splice(index, 1); updateTampilanTotal(); updateTabelRiwayat(); updateOpsiProduk(); updateTabelProduk(); } }
function tampilkanStruk(transaksi) { document.getElementById('struk-nama-toko').innerText = NAMA_TOKO; document.getElementById('struk-alamat-toko').innerText = ALAMAT_TOKO; document.getElementById('struk-kontak-toko').innerText = `Telp: ${KONTAK_TOKO}`; document.getElementById('struk-no-transaksi').innerText = transaksi.id; document.getElementById('struk-tanggal').innerText = transaksi.waktu.toLocaleString('id-ID'); const itemList = document.getElementById('struk-item-list'); itemList.innerHTML = ''; let totalHarga = 0; transaksi.items.forEach(item => { const row = `<tr><td colspan="2">${item.nama}</td></tr><tr><td>${item.jumlah} x ${formatRupiah(item.harga || item.total)}</td><td class="text-right">${formatRupiah(item.total)}</td></tr>`; itemList.innerHTML += row; totalHarga += item.total; }); itemList.innerHTML += `<tr><td colspan="2"><hr></td></tr><tr><td><strong>TOTAL</strong></td><td class="text-right"><strong>${formatRupiah(totalHarga)}</strong></td></tr>`; document.getElementById('struk-modal').style.display = 'flex'; }
function tampilkanStrukDetail(id) { const transaksi = riwayat.find(r => r.id === id); if (transaksi) { tampilkanStruk(transaksi); } }
function tutupStruk() { document.getElementById('struk-modal').style.display = 'none'; }
function printStruk() { window.print(); }
function exportStrukPDF() { const strukElement = document.getElementById('struk-content'); const noTransaksi = document.getElementById('struk-no-transaksi').innerText; html2canvas(strukElement, { scale: 2 }).then(canvas => { const imgData = canvas.toDataURL('image/png'); const pdf = new jsPDF({ orientation: 'portrait', unit: 'pt', format: [canvas.width, canvas.height] }); pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height); pdf.save(`struk_${noTransaksi}.pdf`); }); }
function importData(event) { const file = event.target.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = (e) => { try { const data = new Uint8Array(e.target.result); const workbook = XLSX.read(data, { type: 'array' }); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet); if (jsonData.length > 0 && 'nama' in jsonData[0] && 'harga' in jsonData[0] && 'stok' in jsonData[0]) { produk = jsonData; updateTabelProduk(); updateOpsiProduk(); alert(`Berhasil mengimpor ${jsonData.length} data produk!`); } else { alert('Gagal mengimpor. Pastikan format file Excel benar dan memiliki kolom "nama", "harga", dan "stok".'); } } catch (error) { console.error(error); alert('Terjadi kesalahan saat membaca file.'); } }; reader.readAsArrayBuffer(file); event.target.value = ''; }


// --- FUNGSI RIWAYAT & EXPORT (DIPERBARUI TOTAL) ---

function getDisplayRows() {
    const displayRows = [];
    riwayat.forEach(transaksi => {
        if (transaksi.tipe === 'Penjualan') {
            // Jika penjualan, pecah per item untuk ditampilkan
            transaksi.items.forEach(item => {
                displayRows.push({
                    id: transaksi.id, // ID transaksi asli
                    waktu: transaksi.waktu.toLocaleString('id-ID'),
                    tipe: `Pendapatan ${item.nama}`, // Tipe untuk dikelompokkan
                    keterangan: `${item.jumlah}x ${item.nama}`,
                    catatan: transaksi.catatan,
                    nominal: item.total,
                    tipeAsli: 'Penjualan' // Penanda untuk tombol detail
                });
            });
        } else {
            // Untuk Pemasukan & Pengeluaran
            displayRows.push({
                id: transaksi.id,
                waktu: transaksi.waktu.toLocaleString('id-ID'),
                tipe: transaksi.tipe,
                keterangan: transaksi.items[0].nama,
                catatan: transaksi.catatan,
                nominal: transaksi.total,
                tipeAsli: transaksi.tipe
            });
        }
    });
    return displayRows;
}

function updateTabelRiwayat() {
    const container = document.getElementById('riwayat-container');
    container.innerHTML = '';
    const displayData = getDisplayRows();

    const grouped = displayData.reduce((acc, curr) => {
        (acc[curr.tipe] = acc[curr.tipe] || []).push(curr);
        return acc;
    }, {});

    const sortedGroups = Object.keys(grouped).sort((a, b) => {
        if (a === 'Pemasukan') return -1; if (b === 'Pemasukan') return 1;
        if (a === 'Pengeluaran') return -1; if (b === 'Pengeluaran') return 1;
        return a.localeCompare(b);
    });

    if (sortedGroups.length === 0) {
        container.innerHTML = '<p>Belum ada riwayat transaksi.</p>';
        return;
    }

    sortedGroups.forEach(tipe => {
        const items = grouped[tipe];
        let groupHTML = `<div class="riwayat-group-header">Transaksi ${tipe}</div>`;
        groupHTML += `<table><thead><tr><th>Waktu</th><th>Keterangan</th><th>Catatan</th><th>Nominal</th><th>Aksi</th></tr></thead><tbody>`;
        let subtotal = 0;
        
        items.slice().reverse().forEach(r => {
            subtotal += r.nominal;
            const nominalFormatted = formatRupiah(r.nominal);
            const color = r.nominal < 0 ? '#e74c3c' : '#2ecc71';
            groupHTML += `
                <tr style="color: ${color};">
                    <td>${r.waktu}</td>
                    <td>${r.keterangan}</td>
                    <td>${r.catatan}</td>
                    <td>${nominalFormatted}</td>
                    <td>
                        ${r.tipeAsli === 'Penjualan' ? `<button class="btn btn-info btn-sm" onclick="tampilkanStrukDetail(${r.id})">Detail</button>` : '-'}
                        <button class="btn btn-danger btn-sm" onclick="hapusRiwayat(${r.id})">Hapus</button>
                    </td>
                </tr>`;
        });
        
        groupHTML += `<tr class="subtotal-row"><td colspan="3" style="text-align: right;">Total ${tipe}</td><td colspan="2">${formatRupiah(subtotal)}</td></tr>`;
        groupHTML += `</tbody></table>`;
        container.innerHTML += groupHTML;
    });
}

function exportData(dataType) {
    let data;
    let fileName;

    if (dataType === 'produk') {
        data = produk;
        fileName = 'data_produk.xlsx';
    } else if (dataType === 'riwayat') {
        // Gunakan data yang sudah dipisah untuk ekspor yang sesuai tampilan
        data = getDisplayRows();
        fileName = 'riwayat_transaksi_terpisah.xlsx';
    } else {
        return;
    }

    if (data.length === 0) {
        alert('Tidak ada data untuk diekspor.');
        return;
    }

    const ws = XLSX.utils.json_to_sheet(data);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Data');
    XLSX.writeFile(wb, fileName);
}
</script>
<footer style="text-align: center; margin-top: 20px; font-size: 10px; color: #555;">
        © <span id="year"></span> ᴅᴀᴘᴜʀ ᴅᴏᴀ ᴜᴍɪ x ʀɪꜱᴏʟᴇꜱ ʜʏʀᴀ ✓
    </footer>
</body>
</html>
